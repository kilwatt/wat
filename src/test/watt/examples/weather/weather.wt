import 'net.owm'
import 'std.io'
import 'std.fs'
import 'utils.json'
import 'std.sys'

path := fs.path_of('./weather.json')
api_key := ''

if system.args().size() > 0 {
    if system.args().get(0) == 'reset' {
        io.println('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ owm Ğ°Ğ¿Ğ¸-ĞºĞ»ÑÑ‡Ğ¸Ğº â˜”: ')
        key := io.input()
        fs.write_text(
            path,
            json.encode(
                {
                    'api_key': key
                }
            )
        )
        api_key = key
        io.println('Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾! ğŸŒ')
        system.exit(101)
    }
    else {
        io.println('â˜” ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ½Ğµ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ½Ğ°! Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹: reset')
    }
}

if fs.is_exists(path) {
    io.println('ĞĞ°Ğ¹Ğ´ĞµĞ½ Ñ„Ğ°Ğ¹Ğ»! â˜‚ï¸')
    api_key = json.parse(
        fs.read_text(
            path
        )
    ).get('api_key')
} else {
    io.println('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ owm Ğ°Ğ¿Ğ¸-ĞºĞ»ÑÑ‡Ğ¸Ğº â˜”: ')
    key := io.input()
    fs.write_text(
        path,
        json.encode(
            {
                'api_key': key
            }
        )
    )
    api_key = key
}

io.println('ğŸŒ¦ï¸ ĞĞ¿Ğ¸ ĞºĞ»ÑÑ‡: ' + api_key)
io.println('ğŸŒ¡ï¸ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´: ')
city := io.input()
io.println('ğŸŒ Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ñ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°...')

client := new OwmClient(api_key)
_weather := json.parse(client.city(city, 'ru', WeatherType.JSON))

temperature := _weather.get('main').get('temp') - 273.15
wind := _weather.get('wind').get('speed')
weather := _weather.get('weather').get(0).get('description')

io.println('â•­ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ²: ' + city)
io.println('â”‚ ğŸŒ¡ï¸ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°: ' + temperature + 'Â°ï¸Ğ¡')
io.println('â”‚ ğŸŒ¦ï¸ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ°: ' + weather)
io.println('â”‚ ğŸƒ Ğ’ĞµÑ‚ĞµÑ€: ' + wind + ' Ğ¼/c')
io.println('â•°')